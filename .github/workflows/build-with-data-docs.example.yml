name: Build images with embedded Data Docs (example)

# This is an example GitHub Actions workflow showing how to:
# 1. Generate Data Docs into `uncommitted/data_docs/local_site` (placeholder step)
# 2. Build the package image (the repo's `Dockerfile` builds the wheel and runtime image)
# 3. Build an `nginx` image that embeds the generated Data Docs (using `docker/nginx/Dockerfile.prod`)
# 4. Optionally push images to a registry (commented out)

on:
  workflow_dispatch:

jobs:
  build-with-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Generate Data Docs (CUSTOMIZE)
        run: |
          # === CUSTOMIZE THIS STEP ===
          # Replace the following example with the command you use to generate Data Docs
          # Example 1: run your project's script that generates Data Docs
          # DQ_DATA_SOURCE=ds_sample_data python -m dq_docker.run_adls_checkpoint --generate-docs

          # Example 2: use Great Expectations CLI (v3 API) to build docs
          # great_expectations --v3-api docs build

          echo "Make sure generated site is available under ./uncommitted/data_docs/local_site"

      - name: Build package image
        run: |
          # This builds the package image using the repo Dockerfile
          docker build -t local/dq-docker:latest .

      - name: Build nginx image with embedded Data Docs
        run: |
          # This builds an nginx image that contains the generated Data Docs.
          # It uses `docker/nginx/Dockerfile.prod`, which expects the site at
          # `uncommitted/data_docs/local_site` and the `docker/nginx/nginx.conf` file.
          docker build -t jactools/dq-docker-nginx:latest -f docker/nginx/Dockerfile.prod .

      # Optional: push images to a container registry (uncomment and configure)
      # - name: Log in to registry
      #   uses: docker/login-action@v2
      #   with:
      #     registry: ghcr.io
      #     username: ${{ github.actor }}
      #     password: ${{ secrets.GITHUB_TOKEN }}
      # - name: Push images
      #   run: |
      #     docker tag local/dq-docker:latest ghcr.io/${{ github.repository_owner }}/dq-docker:latest
      #     docker tag jactools/dq-docker-nginx:latest ghcr.io/${{ github.repository_owner }}/dq-docker-nginx:latest
      #     docker push ghcr.io/${{ github.repository_owner }}/dq-docker:latest
      #     docker push ghcr.io/${{ github.repository_owner }}/dq-docker-nginx:latest

      - name: Save build artifacts (optional)
        uses: actions/upload-artifact@v4
        with:
          name: data-docs-site
          path: uncommitted/data_docs/local_site
